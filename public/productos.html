<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - P&G Petshop</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¾</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ¾</div>
            <p class="customer-name">Cliente: <span id="customerNameDisplay"></span></p>
            <h1 class="app-name">P&G Petshop</h1>
            <p class="authors">Desarrollado por: Fabiola Poustis & Julian Ayuso</p>
            <p class="customer-name">Cliente: <span id="customerNameDisplay"></span></p>
            <nav class="main-nav">
                <a href="index.html">Inicio</a>
                <a href="productos.html" class="active">Productos</a>
                <a href="carrito.html">Carrito <span id="cartBadge" class="badge">0</span></a>

            </nav>
        </header>

        <main class="products-screen">
            <div class="welcome-message">
                <h2>Hola <span id="customerGreeting"></span>! ğŸ‘‹</h2>
                <p>Selecciona los productos que deseas comprar</p>
            </div>

 
            <div class="category-filter">
                <button class="filter-btn active" data-category="all">
                    Todos los productos
                </button>
                <button class="filter-btn" data-category="Gato">
                    ğŸ± Productos para Gatos
                </button>
                <button class="filter-btn" data-category="Perro">
                    ğŸ¶ Productos para Perros
                </button>
            </div>


            <div id="loadingProducts" class="loading">
                <div class="spinner"></div>
                <p>Cargando productos...</p>
            </div>

            <div id="errorProducts" class="error-box" style="display: none;">
                <p>âŒ Error al cargar productos. Por favor intenta nuevamente.</p>
                <button onclick="location.reload()" class="btn btn-secondary">Reintentar</button>
            </div>


            <div id="productsGrid" class="products-grid"></div>


            <div id="pagination" class="pagination" style="display: none;">
                <button id="prevPage" class="btn btn-secondary">â† Anterior</button>
                <span id="pageInfo" class="page-info">PÃ¡gina 1 de 1</span>
                <button id="nextPage" class="btn btn-secondary">Siguiente â†’</button>
            </div>

            <div class="floating-cart-btn">
                <a href="carrito.html" class="btn btn-cart">
                    ğŸ›’ Ver Carrito (<span id="cartCount">0</span>)
                </a>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 PetShop AutoServicio. Todos los derechos reservados.</p>
        </footer>
    </div>

<script>
let productosDisponibles = [];
const productsGrid = document.getElementById("productsGrid");
const loading = document.getElementById("loadingProducts");
const errorBox = document.getElementById("errorProducts");

async function cargarProductos(categoria = "all") {
    loading.style.display = "block";
    errorBox.style.display = "none";
    productsGrid.innerHTML = "";

    let url = "/api/productos/activos"; 
    if (categoria !== "all") url += `?categoria=${categoria}`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        const productos = data.productos;

        productosDisponibles = productos;

        productos.forEach(p => {
            const div = document.createElement("div");
            div.classList.add("product-card");
            div.setAttribute("data-product-id", p.id);
            
            const imagenUrl = p.imagen ? `/uploads/${p.imagen}` : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><text y="50%" x="50%" text-anchor="middle" font-size="80">ğŸ¾</text></svg>';
            
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const itemEnCarrito = carrito.find(item => item.id === p.id);
            const cantidadEnCarrito = itemEnCarrito ? itemEnCarrito.cantidad : 0;
            
            div.innerHTML = `
                <img class="product-image" 
                     src="${imagenUrl}" 
                     alt="${p.nombre}"
                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22><text y=%2250%25%22 x=%2250%25%22 text-anchor=%22middle%22 font-size=%2280%22>ğŸ¾</text></svg>'">
                <h3>${p.nombre}</h3>
                <p>${p.descripcion || 'Sin descripciÃ³n'}</p>
                <p class="product-price">$${parseFloat(p.precio).toFixed(2)}</p>
                
                ${cantidadEnCarrito > 0 ? `
                    <div class="product-controls">
                        <button class="btn btn-minus" onclick="disminuirCantidad(${p.id})">âˆ’</button>
                        <span class="product-quantity" id="qty-${p.id}">${cantidadEnCarrito}</span>
                        <button class="btn btn-plus" onclick="agregarAlCarrito(${p.id})">+</button>
                    </div>
                ` : `
                    <button class="btn btn-primary" onclick="agregarAlCarrito(${p.id})">
                        Agregar al carrito
                    </button>
                `}
            `;
            productsGrid.appendChild(div);
        });

        loading.style.display = "none";
    } catch (err) {
        console.error(err);
        loading.style.display = "none";
        errorBox.style.display = "block";
    }
}

document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        cargarProductos(btn.dataset.category);
    });
});

async function agregarAlCarrito(idProducto) {
    try {
        const producto = productosDisponibles.find(p => p.id === idProducto);
        
        if (!producto) {
            alert('Producto no encontrado');
            return;
        }
        
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const productoExistente = carrito.find(item => item.id === idProducto);
        
        if (productoExistente) {
            productoExistente.cantidad++;
        } else {
            carrito.push({
                id: producto.id,
                nombre: producto.nombre,
                precio: producto.precio,
                imagen: producto.imagen || 'default.png',
                cantidad: 1
            });
        }
        
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarBadgeCarrito();
        actualizarBotonProducto(idProducto);
        
    } catch (err) {
        console.error('Error:', err);
        alert('Error al agregar al carrito');
    }
}

function disminuirCantidad(idProducto) {
    let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    const productoIndex = carrito.findIndex(item => item.id === idProducto);
    
    if (productoIndex !== -1) {
        carrito[productoIndex].cantidad--;
        
        if (carrito[productoIndex].cantidad === 0) {
            carrito.splice(productoIndex, 1);
        }
        
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarBadgeCarrito();
        actualizarBotonProducto(idProducto);
    }
}

function actualizarBotonProducto(idProducto) {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    const itemEnCarrito = carrito.find(item => item.id === idProducto);
    const cantidad = itemEnCarrito ? itemEnCarrito.cantidad : 0;
    
    const productoCard = document.querySelector(`[data-product-id="${idProducto}"]`);
    if (!productoCard) return;
    
    const producto = productosDisponibles.find(p => p.id === idProducto);
    if (!producto) return;
    
    const controls = productoCard.querySelector('.product-controls, .btn-primary');
    
    if (cantidad > 0) {
        controls.outerHTML = `
            <div class="product-controls">
                <button class="btn btn-minus" onclick="disminuirCantidad(${idProducto})">âˆ’</button>
                <span class="product-quantity" id="qty-${idProducto}">${cantidad}</span>
                <button class="btn btn-plus" onclick="agregarAlCarrito(${idProducto})">+</button>
            </div>
        `;
    } else {
        controls.outerHTML = `
            <button class="btn btn-primary" onclick="agregarAlCarrito(${idProducto})">
                Agregar al carrito
            </button>
        `;
    }
}

function actualizarBadgeCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    const cantidad = carrito.reduce((sum, item) => sum + item.cantidad, 0);
    
    const badge = document.getElementById('cartBadge');
    const cartCount = document.getElementById('cartCount');
    
    if (badge) badge.textContent = cantidad;
    if (cartCount) cartCount.textContent = cantidad;
}

document.addEventListener('DOMContentLoaded', () => {
        const nombreCliente = localStorage.getItem('nombreCliente') || 'Invitado';
        const displayElement = document.getElementById('customerNameDisplay');
        if (displayElement) {
            displayElement.textContent = nombreCliente;
        }
    });

cargarProductos();
actualizarBadgeCarrito();
</script>

<script src="js/config.js"></script>
<script src="js/productos.js"></script>

</body>
</html>